<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="styles/general.css">
    <link rel="stylesheet" href="styles/overview.css">
    <link rel="stylesheet" href="styles/editor.css">
    <title>Document</title>
</head>
<body>
    <div class="container">
        <div class="main-panel">
            <div class="navigation">
                <a id="nav-overview" href="#overview"><img src="gui-icons/bars-solid.svg" alt="" />Overview</a>
                <a id="nav-editor" href="#editor"><img src="gui-icons/pen-to-square-solid.svg" alt="" />Editor</a>
                <a><img src="gui-icons/gear-solid.svg" alt="" />Settings</a>
                <a><img src="gui-icons/file-arrow-down-solid.svg" alt="" />Download All as Zip</a>
            </div>
            <div class="page" id="editor">
                <div class="editor-menu">
                    <div><img src="gui-icons/file-solid.svg" alt="" />New Card</div>
                    <div><img src="gui-icons/floppy-disk-solid.svg" alt="" />Save</div>
                    <div><img src="gui-icons/trash-solid.svg" alt="" />Delete</div>
                    <div class="card-preview-buttons">
                        <div><img src="gui-icons/eye-solid.svg" alt="Preview"></div>
                        <div><button class="tier-I"   id="preview-tier-I"   >I</button></div>
                        <div><button class="tier-II"  id="preview-tier-II"  >II</button></div>
                        <div><button class="tier-III" id="preview-tier-III" >III</button></div>
                    </div>
                </div>
                <div class="card-id">
                    <div>Card ID</div>
                    <div><input id="card-id" type="text" value="" placeholder="No ID generated yet ..." disabled /></div>
                    
                </div>
                <div>
                    <div>Supertype:</div>
                    <div>
                        <select id="supertype">
                            <option>Nonbasic</option>
                            <option>Basic</option>
                            <option>Ultimate</option>
                        </select>
                    </div>
                    <div>Stats:</div>
                    <div>
                        <select id="stat-type">
                            <option>Profile</option>
                            <option>Inherit</option>
                            <option>Custom</option>
                        </select>
                    </div>
                    <div>Color:</div>
                    <div>
                        <select id="card-color">
                            <option>Red</option>
                            <option>Blue</option>
                            <option>Green</option>
                            <option>Gold</option>
                            <option>Silver</option>
                            <option>Purple</option>
                            <option>Custom</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div>Tiers:</div>
                    <div class="tier">
                        <input type="checkbox" value="I" id="tier-I-toggle" name="tier-toggle" checked>
                        <label for="tier-I-toggle">I</label>
                        <input type="checkbox" value="II" id="tier-II-toggle" name="tier-toggle" checked>
                        <label for="tier-II-toggle">II</label>
                        <input type="checkbox" value="III" id="tier-III-toggle" name="tier-toggle" checked>
                        <label for="tier-III-toggle">III</label>
                    </div>
                    <div>Attributes:</div>
                    <div class="attr">
                        <input type="checkbox" value="initiative" id="initiative-toggle" name="attr-toggle" checked>
                        <label for="initiative-toggle" style="display: none;"><img src="svg/item-initiative.svg" alt="" /></label>
                        <input type="checkbox" value="defense" id="defense-toggle" name="attr-toggle" checked>
                        <label for="defense-toggle"><img src="svg/item-defense.svg" alt="" /></label>
                        <input type="checkbox" value="movement" id="movement-toggle" name="attr-toggle" checked>
                        <label for="movement-toggle"><img src="svg/item-movement.svg" alt="" /></label>
                        <input type="checkbox" value="attack" id="attack-toggle" name="attr-toggle" checked>
                        <label for="attack-toggle"><img src="svg/item-attack.svg" alt="" /></label>
                    </div>
                    <div>Features</div>
                    <div class="features">
                        <div>
                            <!--<input type="radio" value="on" id="features-simple" name="features-toggle">
                            <label for="features-simple">Simple</label>-->
                            <input type="radio" id="features-normal" name="features-toggle" checked>
                            <label for="features-normal">Normal</label>
                            <input type="radio" id="features-advanced" name="features-toggle">
                            <label for="features-advanced">Advanced</label>
                        </div>
                    </div>
                </div>
                <input type="checkbox" value="initiative" id="initiative-hide" checked>
                <div class="stat">
                    <div>Initiative:</div>
                    <div class="stat-profile">
                        <select id="initiative-profile" data-value="Average">
                            <option>Exceptional</option>
                            <option>Very Good</option>
                            <option>Good</option>
                            <option>Above Average</option>
                            <option selected>Average</option>
                            <option>Below Average</option>
                            <option>Poor</option>
                            <option>Very Poor</option>
                            <option>Custom</option>
                        </select>
                    </div>
                    <div>Modifiers</div>
                    <div class="stats">
                        <input id="initiative-tier-I" class="tier-I" type="text" value="0">
                        <input id="initiative-tier-II" class="tier-II" type="text" value="0">
                        <input id="initiative-tier-III" class="tier-III" type="text" value="0">
                    </div>
                    <div>Values</div>
                    <div class="preview stats">
                        <span class="tier-I"   id="preview-initiative-tier-I">...</span>
                        <span class="tier-II"  id="preview-initiative-tier-II">...</span>
                        <span class="tier-III" id="preview-initiative-tier-III">...</span>
                    </div>
                </div>
                <input type="checkbox" value="defense" id="defense-hide" name="attr-toggle" checked>
                <div class="stat">
                    <div>Defense:</div>
                    <div class="stat-profile">
                        <select id="defense-profile" data-value="Average">
                            <option>Exceptional</option>
                            <option>Very Good</option>
                            <option>Good</option>
                            <option>Above Average</option>
                            <option selected>Average</option>
                            <option>Below Average</option>
                            <option>Poor</option>
                            <option>Very Poor</option>
                            <option>Custom</option>
                        </select>
                    </div>
                    <div>Modifiers</div>
                    <div class="stats">
                        <input id="defense-tier-I" class="tier-I" type="text" value="0">
                        <input id="defense-tier-II" class="tier-II" type="text" value="0">
                        <input id="defense-tier-III" class="tier-III" type="text" value="0">
                    </div>
                    <div>Values</div>
                    <div class="preview stats">
                        <span class="tier-I"   id="preview-defense-tier-I">...</span>
                        <span class="tier-II"  id="preview-defense-tier-II">...</span>
                        <span class="tier-III" id="preview-defense-tier-III">...</span>
                    </div>
                </div>
                <input type="checkbox" value="movement" id="movement-hide" name="attr-toggle" checked>
                <div class="stat">
                    <div>Movement:</div>
                    <div class="stat-profile">
                        <select id="movement-profile" data-value="Average">
                            <option>Exceptional</option>
                            <option>Very Good</option>
                            <option>Good</option>
                            <option>Above Average</option>
                            <option selected>Average</option>
                            <option>Below Average</option>
                            <option>Poor</option>
                            <option>Very Poor</option>
                            <option>Custom</option>
                        </select>
                    </div>
                    <div>Modifiers</div>
                    <div class="stats">
                        <input id="movement-tier-I" class="tier-I" type="text" value="0">
                        <input id="movement-tier-II" class="tier-II" type="text" value="0">
                        <input id="movement-tier-III" class="tier-III" type="text" value="0">
                    </div>
                    <div>Values</div>
                    <div class="preview stats">
                        <span class="tier-I"   id="preview-movement-tier-I">...</span>
                        <span class="tier-II"  id="preview-movement-tier-II">...</span>
                        <span class="tier-III" id="preview-movement-tier-III">...</span>
                    </div>
                </div>
                <input type="checkbox" value="attack" id="attack-hide" name="attr-toggle" checked>
                <div class="stat">
                    <div>Attack:<label class="qmark" for="modifiers-help">?</label></div>
                    <div class="stat-profile">
                        <select id="attack-profile" data-value="Average">
                            <option>Exceptional</option>
                            <option>Very Good</option>
                            <option>Good</option>
                            <option>Above Average</option>
                            <option selected>Average</option>
                            <option>Below Average</option>
                            <option>Poor</option>
                            <option>Very Poor</option>
                            <option>Custom</option>
                        </select>
                    </div>
                    <div>Modifiers</div>
                    <div class="stats">
                        <input id="attack-tier-I" class="tier-I" type="text" value="0">
                        <input id="attack-tier-II" class="tier-II" type="text" value="0">
                        <input id="attack-tier-III" class="tier-III" type="text" value="0">
                    </div>
                    <div>Values</div>
                    <div class="preview stats">
                        <span class="tier-I"   id="preview-attack-tier-I">...</span>
                        <span class="tier-II"  id="preview-attack-tier-II">...</span>
                        <span class="tier-III" id="preview-attack-tier-III">...</span>
                    </div>
                </div>
                <input type="checkbox" class="hidden" id="modifiers-help" />
                <div class="help flex-height">
                    <div>Modifiers help</div>
                    <div>
                        <div>
                            <p>
                                <span class="code">X</span>
                                - if a non-custom profile is selected, the value X gets added to the profile baseline. For custom profiles, X becomes the baseline.
                            </p>
                            <p>
                                <span class="code">X+</span>
                                - as above, but the value gets a + added on the end; for conditional scaling. Works with <span class="code">X-</span> too.
                            </p>
                            <p>
                                <span class="code">' '</span>
                                - blank is treated as 0.
                            </p>
                        </div>
                    </div>
                </div>
                <div>
                    <div>Type<label class="qmark" for="type-help">?</label></div>
                    <div class="card-type">
                        <select class="tier-I" id="card-type">
                            <option>Attack</option>
                            <option>Defense</option>
                            <option>Skill</option>
                            <option>Movement</option>
                            <option>Defense/Skill</option>
                            <option hidden>Ultimate</option>
                        </select>
                        <select class="tier-II" id="card-type-tier-II">
                            <option>Attack</option>
                            <option>Defense</option>
                            <option>Skill</option>
                            <option>Movement</option>
                            <option>Defense/Skill</option>
                            <option hidden>Ultimate</option>
                        </select>
                        <select class="tier-III" id="card-type-tier-III">
                            <option>Attack</option>
                            <option>Defense</option>
                            <option>Skill</option>
                            <option>Movement</option>
                            <option>Defense/Skill</option>
                            <option hidden>Ultimate</option>
                        </select>
                    </div>
                </div>
                <input type="checkbox" class="hidden" id="type-help" />
                <div class="help flex-height">
                    <div>Subtype help</div>
                    <div>
                        <div>
                            <p>
                                <span class="code">Changing card type</span>
                                - enabled <span class="code">advanced</span> features to have the card type change across tiers.
                            </p>
                        </div>
                    </div>
                </div>
                <div>
                    <div>Subtype<label class="qmark" for="subtype-help">?</label></div>
                    <div class="subtype">
                        <div>
                            <input type="radio" value="none" id="subtype-none" name="subtype" checked />
                            <label for="subtype-none">
                                <img src="svg/item-none.svg" alt="" />
                            </label>
                            <input type="radio" value="radius" id="subtype-radius" name="subtype" />
                            <label for="subtype-radius">
                                <img src="svg/item-radius.svg" alt="" />
                            </label>
                            <input type="radio" value="range" id="subtype-range" name="subtype" />
                            <label for="subtype-range">
                                <img src="svg/item-range.svg" alt="" />
                            </label>
                        </div>
                    </div>
                    <div class="stats">
                        <input class="tier-I"   type="text" id="subtype-value-tier-I" value="1" disabled>
                        <input class="tier-II"  type="text" id="subtype-value-tier-II" value="1" disabled>
                        <input class="tier-III" type="text" id="subtype-value-tier-III" value="1" disabled>
                    </div>
                </div>
                <input type="checkbox" class="hidden" id="subtype-help" />
                <div class="help flex-height">
                    <div>Subtype help</div>
                    <div>
                        <div>
                            <p>
                                <span class="code">' '</span>
                                - blank is treated as no subtype. Use this if a branch gains a subtype on a later tier.
                            </p>
                        </div>
                    </div>
                </div>
                <div>
                    <div>Name</div>
                    <div class="names">
                        <input class="tier-I"   id="name-tier-I" type="text" value="Tier1 name">
                        <input class="tier-II"  id="name-tier-II" type="text" value="Tier2 name">
                        <input class="tier-III" id="name-tier-III" type="text" value="Tier3 name">
                    </div>
                </div>
                <div class="textbox flex-height">
                    <div>
                        <div>Textbox:</div>
                        <label class="qmark" for="textbox-help">?</label>
                    </div>
                    <div>
                        <textarea id="textbox">Target an enemy unit adjacent to you. After the attack: move {I:1}{II:2}{III:3} space{!I:s} to a space adjacent to the target. **This turn:** You are wild!</textarea>
                    </div>
                </div>
                <input type="checkbox" class="hidden" id="textbox-help" />
                <div class="help flex-height">
                    <div>Textbox help</div>
                    <div>
                        <div>
                            <p>
                                <span class="code">{I:&lt;...&gt;}</span>
                                - shows content only on tier I. Works similarly for <span class="code">{II:&lt;...&gt;}</span> and <span class="code">{III:&lt;...&gt;}</span>.
                            </p>
                            <p>
                                <span class="code">{!I:&lt;...&gt;}</span>
                                - shows content for all tiers except tier I. Works similarly for <span class="code">{!II:&lt;...&gt;}</span> and <span class="code">{!III:&lt;...&gt;}</span>.
                            </p>
                            <p><span class="code">{&lt;tier-I text...&gt;/&lt;tier-II text...&gt;/&lt;tier-III text...&gt;}</span> 
                                - shows each entry only at the indicated tier.
                            </p>
                            <p>
                                <span class="code">{&lt;tier-II text...&gt;/&lt;tier-III text...&gt;}</span> 
                                - as above, but only for tier II and tier III.
                            </p>
                            <p>
                                <span class="code">**<...>**</span> 
                                - transforms content to bold text.
                            </p>
                            <p>
                                <span class="code">* <...></span> 
                                - <span class="code">*</span> become bullets <span class="code">●</span>. Bullets are left-aligned by default.
                            </p>
                            <p>
                                <span class="code">:atk:</span> 
                                - draw the attack icon. Similarly for <span class="code">:def:</span> (defense), <span class="code">:ini:</span> (initiative), <span class="code">:mov:</span> (movement), <span class="code">:rad:</span> (radius), and <span class="code">:rng:</span> (range).
                            </p>
                            <p>
                                <span class="code">':left/right/center: <...>'</span> 
                                - Start a line with <span class="code">':left: '</span> to left-align the text. Works similarly for <span class="code">:center:</span> an (not that I think you will ever need it) <span class="code">:right:</span>.
                            </p>
                        </div>
                    </div>
                </div>
                <div>
                    <div>Item:</div>
                    <div class="items">
                        <div class="tier-I">
                            <img src="svg/item-none.svg" alt="" />
                        </div>
                        <div class="tier-II">
                            <input type="radio" value="attack" id="item-tier-II-attack" name="tier-II-item" checked />
                            <label for="item-tier-II-attack">
                                <img src="svg/item-attack.svg" alt="" />
                            </label>
                            <input type="radio" value="defense" id="item-tier-II-defense" name="tier-II-item" />
                            <label for="item-tier-II-defense">
                                <img src="svg/item-defense.svg" alt="" />
                            </label>
                            <input type="radio" value="initiative" id="item-tier-II-initiative" name="tier-II-item" />
                            <label for="item-tier-II-initiative">
                                <img src="svg/item-initiative.svg" alt="" />
                            </label>
                        </div>
                        <div class="tier-III">
                            <input type="radio" value="attack" id="item-tier-III-attack" name="tier-III-item" checked />
                            <label for="item-tier-III-attack">
                                <img src="svg/item-attack.svg" alt="" />
                            </label>
                            <input type="radio" value="defense" id="item-tier-III-defense" name="tier-III-item" />
                            <label for="item-tier-III-defense">
                                <img src="svg/item-defense.svg" alt="" />
                            </label>
                            <input type="radio" value="initiative" id="item-tier-III-initiative" name="tier-III-item" />
                            <label for="item-tier-III-initiative">
                                <img src="svg/item-initiative.svg" alt="" />
                            </label>
                            <input type="radio" value="movement" id="item-tier-III-movement" name="tier-III-item" />
                            <label for="item-tier-III-movement">
                                <img src="svg/item-movement.svg" alt="" />
                            </label>
                            <input type="radio" value="radius" id="item-tier-III-radius" name="tier-III-item" />
                            <label for="item-tier-III-radius">
                                <img src="svg/item-radius.svg" alt="" />
                            </label>
                            <input type="radio" value="range" id="item-tier-III-range" name="tier-III-item" />
                            <label for="item-tier-III-range">
                                <img src="svg/item-range.svg" alt="" />
                            </label>
                        </div>
                    </div>
                </div>
                <div class="debug">
                    <div>Debug</div>
                    <div><button id="test-new">New card!</button></div>
                    <div><button id="test-save">Save!</button></div>
                    <div><button id="test-load">Load!</button></div>
                    <div><input type="number" value="0" id="test-load-id" /></div>
                    <div><button id="test-clear">Clear All</button></div>
                    <div><button id="test-store">Check!</button></div>
                    <div><span id="local-store-txt">32</span> KB</div>
                </div>
            </div>
            <div class="page" id="overview">
                <div>
                    <div>Hero information here!</div>
                    <div>TestC</div>
                </div>
                <div id="branch-list"></div>
                <!--<div>test</div>
                <div>test</div>-->
            </div>
        </div>
        <div class="side-panel">
            <div class="preview-column">
                <div class="card-preview">
                    <canvas id="card" width="630" height="880" style=""></canvas>
                    <button id="card-preview-save"><img src="gui-icons/file-arrow-down-solid.svg" alt="Download"></button>
                </div>
                <div>
                    Storage usage: Y KB.
                </div>
            </div>
        </div>
    </div>
    <template id="branch-template">
        <div class="branch">
            <!--<div class="branch-color"></div>-->
            <div class="branch-type">
                <img class="type-icon" alt="" />
                <img class="subtype-icon" alt="" />
            </div>
            <div class="branch-content">
                <div class="branch-initiative">
                    <img alt="" /><span>9,9,10</span>
                </div>
                <div class="branch-defense">
                    <img alt="" /><span>9,9,10</span>
                </div>
                <div class="branch-movement">
                    <img alt="" /><span>9,9,10</span>
                </div>
                <div class="branch-attack">
                    <img alt="" /><span>9,9,10</span>
                </div>
                <span class="branch-items">
                    <img alt="" />
                    <img alt="" />
                </span>
            </div>
            <div class="branch-actions">
                <a href="#editor"><img src="gui-icons/pen-to-square-solid.svg" alt="" /> Edit</a>
            </div>
            <div class="branch-preview">
            </div>
        </div>
    </template>
    <!-- OVERVIEW SCRIPT -->
    <script type="module">
    import { render } from "./modules/card-render.js";
    import * as storage from "./modules/storage.js";
    import { color_map, lightenColor } from "./modules/colors.js";
    import * as editor from "./modules/editor.js";
    import { getStats } from "./modules/statProfiles.js";
    
    const nav_overview = document.getElementById("nav-overview");
    const canvas = document.getElementById("card");
    const ctx = canvas.getContext("2d");
    
    window.addEventListener('DOMContentLoaded',function () {
        populate_branch_list();
    });

    nav_overview.addEventListener("click", function (e) {
        console.log("Overview clicked!")
        populate_branch_list();
    });

    function populate_branch_list() {
        const branch_list = document.getElementById("branch-list");
        branch_list.innerHTML = "";

        var branches = storage.getBranches();

        let ordering = {
            'gold': [0, 0],
            'silver': [1, 1],
            'red': [2, 3],
            'blue': [4, 5],
            'green': [6, 7],
            'purple': [8, 8],
            'other': 10
        }

        branches.forEach(function (branch_id) {
            let branch = storage.getBranch(branch_id);

            const template = document.querySelector("#branch-template");
            const clone = template.content.cloneNode(true);

            let divBranch = clone.querySelector(".branch");
            if (branch['id'] == editor.input_card_id.value) {
                divBranch.classList.add('open-in-editor');
            }
            let fg_color = color_map[branch.color];
            let bg_color = lightenColor(color_map[branch.color], 0.875);
            divBranch.style.setProperty('--fg-color', fg_color);
            divBranch.style.setProperty('--bg-color', bg_color);
            
            // TYPE
            let type = branch.type;
            if (typeof(type) == "object")
                type = type[0];
            type = type.toLowerCase();
            let img = clone.querySelector(".type-icon");
            img.src = "icons/" + type + ".png";

            // SUBTYPE
            let subtype = branch.subtype;
            if (subtype != "none") {
                let img = clone.querySelector(".subtype-icon");
                img.src = "svg/item-" + subtype + ".svg";
            }

            // STATS
            ["initiative", "defense", "movement", "attack"].forEach(function (stat) {
                let img;
                img = clone.querySelector(".branch-" + stat + " > img");
                img.src = "svg/item-" + stat + ".svg";
                
                let span;
                span = clone.querySelector(".branch-" + stat + " > span");
                if (Object.keys(branch).indexOf(stat) > -1) {
                    let stats = getStats(stat, branch, {});
                    span.innerHTML = stats.join(','); //branch[stat];
                    if (stat == "movement" && stats.slice(0, 1)[0] == stats.slice(-1)[0]) {
                        span.innerHTML = stats.slice(0, 1)[0];
                    }
                } else {
                    span.innerHTML = "-";
                    span.style.setProperty('color', '#BFBFBF');
                    img.style.setProperty('filter', 'invert(.25)');
                }
            });

            let itemsDiv = clone.querySelector(".branch-items");
            let imgs = itemsDiv.children;
            for (var i = 0; i < 2; i++) {
                if (branch['tier'][i+1]) {
                    imgs[i].src = "svg/item-" + branch['item'][i+1] + ".svg";
                }
            }
            
            let editBtn = clone.querySelector(".branch-actions > a");
            editBtn.addEventListener('click', function (e) {
                console.log(branch)
                editor.set_branch(branch);
                editor.guiUpdate("features");
                editor.guiUpdate("color");
            });

            var branch_preview = clone.querySelector(".branch-preview");
            branch['tier'].forEach(function (e, i) {
                if (e) {
                    let div = document.createElement("div");
                    let tier = 'I'.repeat(i+1)
                    div.innerHTML = tier;
                    div.addEventListener("mouseover", function (ee) {
                        render(ctx, canvas, editor.getCard(branch, tier));
                    });
                    branch_preview.append(div);
                }
            });

            if (Object.keys(ordering).indexOf(branch.color) > -1) {
                divBranch.style.setProperty('order', ordering[branch.color][0]);
                ordering[branch.color][0]++;
                if (ordering[branch.color][0] > ordering[branch.color][1])
                    delete ordering[branch.color];
            } else {
                divBranch.style.setProperty('order', ordering['other']); 
                ordering['other']++;
            }
            branch_list.appendChild(clone);
        });
        
    }

    </script>
    <!-- EDITOR SCRIPT -->
    <script type="module">
        import { asset_loader, render } from "./modules/card-render.js";
        import { card as demo_card } from "./modules/demoCards.js";
        import * as editor from "./modules/editor.js";
        import * as storage from "./modules/storage.js";

        // GLOBALS
        var currentTier = 'I';
        var renderReady = false;
        const canvas = document.getElementById("card");
        const ctx = canvas.getContext("2d");

        // WINDOW IS READY
        window.addEventListener('DOMContentLoaded',function () {

            // Load existing WORKSPACE if available
            if (localStorage.getItem('workspace') != null) {
                editor.set_branch(storage.loadWorkSpace());
            }

            // Refresh editor
            editor.guiUpdate("features");
            editor.guiUpdate("color");
            
            asset_loader(function() { 
                renderReady = true;
                //document.getElementById("preview-tier-I").click();
                editorValueChange();
            });
        });

        function editorValueChange() {
            storage.saveWorkSpace(editor.get_branch());
            drawCard();
        }

        function drawCard(tier = '') {
            if (!renderReady) return;
            if (tier == '') tier = currentTier;
            let branch = editor.get_branch();
            let card = editor.getCard(branch, tier);
            render(ctx, canvas, card);
        }

        // ============================================================================
        // ============================================================================
        // TESTING CODE
        document.getElementById("test-new").addEventListener("click", function (e) {
            editor.input_card_id.value = "";
        });

        document.getElementById("test-save").addEventListener("click", function (e) {
            let branch = editor.get_branch();
            console.log(branch);
            storage.save(branch);
        });
        
        document.getElementById("test-load").addEventListener("click", function (e) {
            let val = parseInt(document.getElementById('test-load-id').value);
            console.log(val);
            let branch = storage.getBranches()[val];
            console.log(branch);
            if (branch != null)
            editor.set_branch(storage.getBranch(branch));
            editor.guiUpdate("features");
            editor.guiUpdate("color");
        });
        
        document.getElementById("test-clear").addEventListener("click", function (e) {
            localStorage.clear();
        });

        document.getElementById("test-store").addEventListener("click", function (e) {
            var val_kb = storage.localStorageSize();
            var val_pct = 100 * val_kb / (5 * 1024);
            document.getElementById("local-store-txt").innerHTML = "(" + parseInt(100 * val_pct)/100 + "%) " + parseInt(val_kb);
        });

        // ============================================================================
        // ============================================================================

        ['I','II','III'].forEach(function (tier, i) {
            document.getElementById("preview-tier-"+tier)
                .addEventListener("click", function (e) {
                    currentTier = tier;
                    editorValueChange();
            });
        });

        editor.select_supertype.addEventListener("change", 
            function (e) { editor.guiUpdate("supertype"); drawCard(); });
        
        editor.select_card_color.addEventListener("change", 
            function (e) { editor.guiUpdate("color"); drawCard(); });
        
        editor.select_type.addEventListener("change", 
            function (e) { editor.guiUpdate(); drawCard(); });

        editor.input_features_toggle.forEach(function (e) {
            e.addEventListener("change", 
                function (ee) { editor.guiUpdate("features"); }); });        

        ['attack','defense','movement','initiative'].forEach(function (stat) {
            editor.select_stat_profile(stat).addEventListener("change", function (e) {
                if (editor.select_stat_type.value == "Profile")
                    e.target.dataset.value = e.target.value;
                editor.guiUpdate();
                editorValueChange();  
            });
            
            editor.input_stats(stat).forEach(function (e) {
                e.addEventListener("change", function (v) { 
                    editor.guiUpdate();
                    editorValueChange();  
                });
            });

            // Attribute hiding
            editor.input_stat_toggle(stat).addEventListener("change", function (e) {
                const checked = e.target.checked;
                document.getElementById(stat +"-hide").checked = checked;

                const opts = editor.select_type.children;
                const type = editor.select_type.value;
                for (var i = 0; i < opts.length; i++) {
                    const OPT = opts[i].value;
                    const opt = OPT.toLowerCase();
                    if (opt == stat) {
                        opts[i].hidden = !checked;
                        if (OPT == type && !checked)
                            editor.select_type.value = "Skill";
                    }
                    if (opt == 'defense/skill' && stat == "defense") {
                        opts[i].hidden = !checked;
                        if (OPT == type && !checked)
                            editor.select_type.value = "Skill";
                    }
                }
                editor.guiUpdate();
                editorValueChange();  
            });
        });

        editor.select_stat_type.addEventListener("change", function (e) {
            const val = e.target.value;
            const elem_list = document.getElementsByClassName("stat-profile");
            for (var i = 0; i < elem_list.length; i++) {
                const ee = elem_list[i].firstElementChild;
                if (val == "Custom") {
                    ee.value = val;
                    ee.disabled = true;
                } else {
                    ee.disabled = (val == "Inherit");
                }
                if (val == "Profile") {
                    ee.value = ee.dataset.value;
                }
            }
            editor.guiUpdate();
            editorValueChange();
        });

        editor.input_tier_toggle.forEach(function (e) {
            e.addEventListener("change", function (v) {
                const check = v.target.checked;
                const tier = v.target.value;
                const elem_list = document.getElementsByClassName("tier-" + tier);
                for (var i = 0; i < elem_list.length; i++) {
                    const ee = elem_list[i];
                    if (ee.tagName == "INPUT" || ee.tagName == "SELECT" || ee.tagName == "BUTTON") {

                        // Deal with subtype-value boxes
                        if (ee.id.slice(0, 18) == "subtype-value-tier") {
                            if (document.getElementById("subtype-none").checked)
                                ee.disabled = true;
                            else
                                ee.disabled = !check;
                            continue;
                        } 

                        // Deal with type-select
                        if (ee.id == "card-type") {
                            if (editor.get_feature_level() == "advanced") {
                                ee.disabled = !check;
                            } else {
                                ee.disabled = false;
                            }
                            continue;
                        }
                        ee.disabled = !check;
                    } else if (ee.tagName == "DIV" || ee.tagName == "SPAN") {
                        if (!check) 
                            ee.classList.add("disabled");  
                        else
                            ee.classList.remove("disabled");  
                    } else {
                        ee.style.display = check ? "block" : "none";
                    }
                }
            });
        });

        editor.input_subtype.forEach(function (e) {
            e.addEventListener("change", function (v) {
                editor.input_subtype_value.forEach(function (e, i) {
                    if (v.target.value == "none") {
                        e.disabled = true;
                    } else {
                        e.disabled = !editor.input_tier_toggle[i].checked;
                    }
                });
                editorValueChange(); 
            });
        });

        editor.input_subtype_value.forEach(function (e, i) {
            e.addEventListener("change", function (ee) {
                currentTier = 'I'.repeat(i+1);
                editorValueChange(); 
            });
        });

        editor.input_name.forEach(function (e, i) {
            e.addEventListener("input", function (ee) {
                currentTier = 'I'.repeat(i+1);
                editorValueChange(); 
            });
        });

        editor.input_textbox.addEventListener("input", function (e) {
            editorValueChange(); 
        });

        editor.input_tier_ii_item.forEach(function (e) {
            e.addEventListener("change", function (v) {
                currentTier = 'II';
                editorValueChange();
            });
        });

        editor.input_tier_iii_item.forEach(function (e) {
            e.addEventListener("change", function (v) {
                currentTier = 'III';
                editorValueChange(); 
            });
        });

        // DEMO STUFF
        //var event_input = new Event('input');
        //input_textbox.dispatchEvent(event_input);
        //updatePreviews(editor.input_textbox.value);

        
    </script>
    <script type="module">
        let saveBtn = document.getElementById("card-preview-save");
        saveBtn.addEventListener('click', function (e) {
            saveCanvasAsPNG();
        });

        function saveCanvasAsPNG() {
            // Get the canvas element and its context
            var canvas = document.getElementById("card");
            var ctx = canvas.getContext("2d");

            // Convert the canvas content to a data URL
            var dataURL = canvas.toDataURL("image/png");

            // Create a link element
            var link = document.createElement("a");
            link.href = dataURL;
            link.download = "card.png"; // Set the file name

            // Simulate a click on the link to trigger the download
            link.click();
        }
    </script>
</body>
</html>