<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="styles/editor.css">
    <!--<script src="drawColored.js"></script>-->
    <!--<script src="cards.js"></script>-->
    <!--<script type="module" src="card-render.js"></script>-->
    <!--<script src="editor.js"></script>-->
    <script src="app.js"></script>
    <title>Document</title>
</head>
<body>
    <div class="container">
        <div class="main-panel">
            <div class="navigation">
                <div><img src="gui-icons/angle-left-solid.svg" alt="" />Back</div>
                <div><img src="gui-icons/pen-to-square-solid.svg" alt="" />Editor</div>
                <div><img src="gui-icons/gear-solid.svg" alt="" />Settings</div>
                <div><img src="gui-icons/floppy-disk-solid.svg" alt="" />Save</div>
                <div><img src="gui-icons/file-arrow-down-solid.svg" alt="" />Download</div>
            </div>
            <div class="editor">
                <div class="card-id">
                    <div>Card ID</div>
                    <div><input id="card-id" type="text" value="" placeholder="No ID generated yet ..." disabled /></div>
                </div>
                <div>
                    <div>Supertype:</div>
                    <div>
                        <select id="supertype">
                            <option>Nonbasic</option>
                            <option>Basic</option>
                            <option>Ultimate</option>
                        </select>
                    </div>
                    <div>Stats:</div>
                    <div>
                        <select id="stat-type">
                            <option>Profile</option>
                            <option>Inherit</option>
                            <option>Custom</option>
                        </select>
                    </div>
                    <div>Color:</div>
                    <div>
                        <select id="card-color">
                            <option>Red</option>
                            <option>Blue</option>
                            <option>Green</option>
                            <option>Gold</option>
                            <option>Silver</option>
                            <option>Purple</option>
                            <option>Custom</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div>Tiers:</div>
                    <div class="tier">
                        <input type="checkbox" value="I" id="tier-I-toggle" name="tier-toggle" checked>
                        <label for="tier-I-toggle">I</label>
                        <input type="checkbox" value="II" id="tier-II-toggle" name="tier-toggle" checked>
                        <label for="tier-II-toggle">II</label>
                        <input type="checkbox" value="III" id="tier-III-toggle" name="tier-toggle" checked>
                        <label for="tier-III-toggle">III</label>
                    </div>
                    <div>Attributes:</div>
                    <div class="attr">
                        <input type="checkbox" value="initiative" id="initiative-toggle" name="attr-toggle" checked>
                        <label for="initiative-toggle" style="display: none;"><img src="svg/item-initiative.svg" alt="" /></label>
                        <input type="checkbox" value="defense" id="defense-toggle" name="attr-toggle" checked>
                        <label for="defense-toggle"><img src="svg/item-defense.svg" alt="" /></label>
                        <input type="checkbox" value="movement" id="movement-toggle" name="attr-toggle" checked>
                        <label for="movement-toggle"><img src="svg/item-movement.svg" alt="" /></label>
                        <input type="checkbox" value="attack" id="attack-toggle" name="attr-toggle" checked>
                        <label for="attack-toggle"><img src="svg/item-attack.svg" alt="" /></label>
                    </div>
                    <div>Features</div>
                    <div class="features">
                        <div>
                            <!--<input type="radio" value="on" id="features-simple" name="features-toggle">
                            <label for="features-simple">Simple</label>-->
                            <input type="radio" id="features-normal" name="features-toggle" checked>
                            <label for="features-normal">Normal</label>
                            <input type="radio" id="features-advanced" name="features-toggle">
                            <label for="features-advanced">Advanced</label>
                        </div>
                    </div>
                </div>
                <input type="checkbox" value="initiative" id="initiative-hide" checked>
                <div class="stat">
                    <div>Initiative:</div>
                    <div class="stat-profile">
                        <select id="initiative-profile" data-value="Average">
                            <option>Exceptional</option>
                            <option>Very Good</option>
                            <option>Good</option>
                            <option>Above Average</option>
                            <option selected>Average</option>
                            <option>Below Average</option>
                            <option>Poor</option>
                            <option>Very Poor</option>
                            <option>Custom</option>
                        </select>
                    </div>
                    <div>Modifiers</div>
                    <div class="stats">
                        <input id="initiative-tier-I" class="tier-I" type="text" value="0">
                        <input id="initiative-tier-II" class="tier-II" type="text" value="0">
                        <input id="initiative-tier-III" class="tier-III" type="text" value="0">
                    </div>
                    <div>Values</div>
                    <div class="preview stats">
                        <span class="tier-I"   id="preview-initiative-tier-I">...</span>
                        <span class="tier-II"  id="preview-initiative-tier-II">...</span>
                        <span class="tier-III" id="preview-initiative-tier-III">...</span>
                    </div>
                </div>
                <input type="checkbox" value="defense" id="defense-hide" name="attr-toggle" checked>
                <div class="stat">
                    <div>Defense:</div>
                    <div class="stat-profile">
                        <select id="defense-profile" data-value="Average">
                            <option>Exceptional</option>
                            <option>Very Good</option>
                            <option>Good</option>
                            <option>Above Average</option>
                            <option selected>Average</option>
                            <option>Below Average</option>
                            <option>Poor</option>
                            <option>Very Poor</option>
                            <option>Custom</option>
                        </select>
                    </div>
                    <div>Modifiers</div>
                    <div class="stats">
                        <input id="defense-tier-I" class="tier-I" type="text" value="0">
                        <input id="defense-tier-II" class="tier-II" type="text" value="0">
                        <input id="defense-tier-III" class="tier-III" type="text" value="0">
                    </div>
                    <div>Values</div>
                    <div class="preview stats">
                        <span class="tier-I"   id="preview-defense-tier-I">...</span>
                        <span class="tier-II"  id="preview-defense-tier-II">...</span>
                        <span class="tier-III" id="preview-defense-tier-III">...</span>
                    </div>
                </div>
                <input type="checkbox" value="movement" id="movement-hide" name="attr-toggle" checked>
                <div class="stat">
                    <div>Movement:</div>
                    <div class="stat-profile">
                        <select id="movement-profile" data-value="Average">
                            <option>Exceptional</option>
                            <option>Very Good</option>
                            <option>Good</option>
                            <option>Above Average</option>
                            <option selected>Average</option>
                            <option>Below Average</option>
                            <option>Poor</option>
                            <option>Very Poor</option>
                            <option>Custom</option>
                        </select>
                    </div>
                    <div>Modifiers</div>
                    <div class="stats">
                        <input id="movement-tier-I" class="tier-I" type="text" value="0">
                        <input id="movement-tier-II" class="tier-II" type="text" value="0">
                        <input id="movement-tier-III" class="tier-III" type="text" value="0">
                    </div>
                    <div>Values</div>
                    <div class="preview stats">
                        <span class="tier-I"   id="preview-movement-tier-I">...</span>
                        <span class="tier-II"  id="preview-movement-tier-II">...</span>
                        <span class="tier-III" id="preview-movement-tier-III">...</span>
                    </div>
                </div>
                <input type="checkbox" value="attack" id="attack-hide" name="attr-toggle" checked>
                <div class="stat">
                    <div>Attack:<label class="qmark" for="modifiers-help">?</label></div>
                    <div class="stat-profile">
                        <select id="attack-profile" data-value="Average">
                            <option>Exceptional</option>
                            <option>Very Good</option>
                            <option>Good</option>
                            <option>Above Average</option>
                            <option selected>Average</option>
                            <option>Below Average</option>
                            <option>Poor</option>
                            <option>Very Poor</option>
                            <option>Custom</option>
                        </select>
                    </div>
                    <div>Modifiers</div>
                    <div class="stats">
                        <input id="attack-tier-I" class="tier-I" type="text" value="0">
                        <input id="attack-tier-II" class="tier-II" type="text" value="0">
                        <input id="attack-tier-III" class="tier-III" type="text" value="0">
                    </div>
                    <div>Values</div>
                    <div class="preview stats">
                        <span class="tier-I"   id="preview-attack-tier-I">...</span>
                        <span class="tier-II"  id="preview-attack-tier-II">...</span>
                        <span class="tier-III" id="preview-attack-tier-III">...</span>
                    </div>
                </div>
                <input type="checkbox" class="hidden" id="modifiers-help" />
                <div class="help flex-height">
                    <div>Modifiers help</div>
                    <div>
                        <div>
                            <p>
                                <span class="code">X</span>
                                - if a non-custom profile is selected, the value X gets added to the profile baseline. For custom profiles, X becomes the baseline.
                            </p>
                            <p>
                                <span class="code">X+</span>
                                - as above, but the value gets a + added on the end; for conditional scaling. Works with <span class="code">X-</span> too.
                            </p>
                            <p>
                                <span class="code">' '</span>
                                - blank is treated as 0.
                            </p>
                        </div>
                    </div>
                </div>
                <div>
                    <div>Type<label class="qmark" for="type-help">?</label></div>
                    <div class="card-type">
                        <select class="tier-I" id="card-type">
                            <option>Attack</option>
                            <option>Defense</option>
                            <option>Skill</option>
                            <option>Movement</option>
                            <option>Defense/Skill</option>
                            <option hidden>Ultimate</option>
                        </select>
                        <select class="tier-II" id="card-type-tier-II">
                            <option>Attack</option>
                            <option>Defense</option>
                            <option>Skill</option>
                            <option>Movement</option>
                            <option>Defense/Skill</option>
                            <option hidden>Ultimate</option>
                        </select>
                        <select class="tier-III" id="card-type-tier-III">
                            <option>Attack</option>
                            <option>Defense</option>
                            <option>Skill</option>
                            <option>Movement</option>
                            <option>Defense/Skill</option>
                            <option hidden>Ultimate</option>
                        </select>
                    </div>
                </div>
                <input type="checkbox" class="hidden" id="type-help" />
                <div class="help flex-height">
                    <div>Subtype help</div>
                    <div>
                        <div>
                            <p>
                                <span class="code">Changing card type</span>
                                - enabled <span class="code">advanced</span> features to have the card type change across tiers.
                            </p>
                        </div>
                    </div>
                </div>
                <div>
                    <div>Subtype<label class="qmark" for="subtype-help">?</label></div>
                    <div class="subtype">
                        <div>
                            <input type="radio" value="none" id="subtype-none" name="subtype" checked />
                            <label for="subtype-none">
                                <img src="svg/item-none.svg" alt="" />
                            </label>
                            <input type="radio" value="radius" id="subtype-radius" name="subtype" />
                            <label for="subtype-radius">
                                <img src="svg/item-radius.svg" alt="" />
                            </label>
                            <input type="radio" value="range" id="subtype-range" name="subtype" />
                            <label for="subtype-range">
                                <img src="svg/item-range.svg" alt="" />
                            </label>
                        </div>
                    </div>
                    <div class="stats">
                        <input class="tier-I"   type="text" id="subtype-value-tier-I" value="1" disabled>
                        <input class="tier-II"  type="text" id="subtype-value-tier-II" value="1" disabled>
                        <input class="tier-III" type="text" id="subtype-value-tier-III" value="1" disabled>
                    </div>
                </div>
                <input type="checkbox" class="hidden" id="subtype-help" />
                <div class="help flex-height">
                    <div>Subtype help</div>
                    <div>
                        <div>
                            <p>
                                <span class="code">' '</span>
                                - blank is treated as no subtype. Use this if a branch gains a subtype on a later tier.
                            </p>
                        </div>
                    </div>
                </div>
                <div>
                    <div>Name</div>
                    <div class="names">
                        <input class="tier-I"   id="name-tier-I" type="text" value="Tier1 name">
                        <input class="tier-II"  id="name-tier-II" type="text" value="Tier2 name">
                        <input class="tier-III" id="name-tier-III" type="text" value="Tier3 name">
                    </div>
                </div>
                <div class="textbox flex-height">
                    <div>
                        <div>Textbox:</div>
                        <label class="qmark" for="textbox-help">?</label>
                    </div>
                    <div>
                        <textarea id="textbox">Target an enemy unit adjacent to you. After the attack: move {I:1}{II:2}{III:3} space{!I:s} to a space adjacent to the target. **This turn:** You are wild!</textarea>
                    </div>
                </div>
                <input type="checkbox" class="hidden" id="textbox-help" />
                <div class="help flex-height">
                    <div>Textbox help</div>
                    <div>
                        <div>
                            <p>
                                <span class="code">{I:&lt;...&gt;}</span>
                                - shows content only on tier I. Works similarly for <span class="code">{II:&lt;...&gt;}</span> and <span class="code">{III:&lt;...&gt;}</span>.
                            </p>
                            <p>
                                <span class="code">{!I:&lt;...&gt;}</span>
                                - shows content for all tiers except tier I. Works similarly for <span class="code">{!II:&lt;...&gt;}</span> and <span class="code">{!III:&lt;...&gt;}</span>.
                            </p>
                            <p><span class="code">{&lt;tier-I text...&gt;/&lt;tier-II text...&gt;/&lt;tier-III text...&gt;}</span> 
                                - shows each entry only at the indicated tier.
                            </p>
                            <p>
                                <span class="code">{&lt;tier-II text...&gt;/&lt;tier-III text...&gt;}</span> 
                                - as above, but only for tier II and tier III.
                            </p>
                            <p>
                                <span class="code">**<...>**</span> 
                                - transforms content to bold text.
                            </p>
                            <p>
                                <span class="code">* <...></span> 
                                - <span class="code">*</span> become bullets <span class="code">‚óè</span>. Bullets are left-aligned by default.
                            </p>
                            <p>
                                <span class="code">:atk:</span> 
                                - draw the attack icon. Similarly for <span class="code">:def:</span> (defense), <span class="code">:ini:</span> (initiative), <span class="code">:mov:</span> (movement), <span class="code">:rad:</span> (radius), and <span class="code">:rng:</span> (range).
                            </p>
                            <p>
                                <span class="code">':left/right/center: <...>'</span> 
                                - Start a line with <span class="code">':left: '</span> to left-align the text. Works similarly for <span class="code">:center:</span> an (not that I think you will ever need it) <span class="code">:right:</span>.
                            </p>
                        </div>
                    </div>
                </div>
                <div>
                    <div>Item:</div>
                    <div class="items">
                        <div class="tier-I">
                            <img src="svg/item-none.svg" alt="" />
                        </div>
                        <div class="tier-II">
                            <input type="radio" value="attack" id="item-tier-II-attack" name="tier-II-item" checked />
                            <label for="item-tier-II-attack">
                                <img src="svg/item-attack.svg" alt="" />
                            </label>
                            <input type="radio" value="defense" id="item-tier-II-defense" name="tier-II-item" />
                            <label for="item-tier-II-defense">
                                <img src="svg/item-defense.svg" alt="" />
                            </label>
                            <input type="radio" value="initiative" id="item-tier-II-initiative" name="tier-II-item" />
                            <label for="item-tier-II-initiative">
                                <img src="svg/item-initiative.svg" alt="" />
                            </label>
                        </div>
                        <div class="tier-III">
                            <input type="radio" value="attack" id="item-tier-III-attack" name="tier-III-item" checked />
                            <label for="item-tier-III-attack">
                                <img src="svg/item-attack.svg" alt="" />
                            </label>
                            <input type="radio" value="defense" id="item-tier-III-defense" name="tier-III-item" />
                            <label for="item-tier-III-defense">
                                <img src="svg/item-defense.svg" alt="" />
                            </label>
                            <input type="radio" value="initiative" id="item-tier-III-initiative" name="tier-III-item" />
                            <label for="item-tier-III-initiative">
                                <img src="svg/item-initiative.svg" alt="" />
                            </label>
                            <input type="radio" value="movement" id="item-tier-III-movement" name="tier-III-item" />
                            <label for="item-tier-III-movement">
                                <img src="svg/item-movement.svg" alt="" />
                            </label>
                            <input type="radio" value="radius" id="item-tier-III-radius" name="tier-III-item" />
                            <label for="item-tier-III-radius">
                                <img src="svg/item-radius.svg" alt="" />
                            </label>
                            <input type="radio" value="range" id="item-tier-III-range" name="tier-III-item" />
                            <label for="item-tier-III-range">
                                <img src="svg/item-range.svg" alt="" />
                            </label>
                        </div>
                    </div>
                </div>
                <div class="debug">
                    <div>Debug</div>
                    <div><button id="test-new">New card!</button></div>
                    <div><button id="test-save">Save!</button></div>
                    <div><button id="test-load">Load!</button></div>
                    <div><input type="number" value="0" id="test-load-id" /></div>
                    <div><button id="test-clear">Clear All</button></div>
                    <div><button id="test-log">localStorage</button></div>
                </div>
            </div>
        </div>
        <div class="side-panel">
            <div class="preview-column">
                <div class="card-preview">
                    <canvas id="card" width="630" height="880" style=""></canvas>
                    <button onclick="saveCanvasAsPNG()"><img src="gui-icons/file-arrow-down-solid.svg" alt="Download"></button>
                </div>
                <div class="card-preview-buttons">
                    <div><img src="gui-icons/eye-solid.svg" alt="Preview"></div>
                    <div><button class="tier-I"   id="preview-tier-I"   >Tier I</button></div>
                    <div><button class="tier-II"  id="preview-tier-II"  >Tier II</button></div>
                    <div><button class="tier-III" id="preview-tier-III" >Tier III</button></div>
                </div>
                <div class="textbox-preview">
                    <div class="preview">
                        <p class="tier-I"><b>Tier I:</b> <span id="textbox-tier-I">...</span></p>
                        <p class="tier-II"><b>Tier II:</b> <span id="textbox-tier-II">...</span></p>
                        <p class="tier-III"><b>Tier III:</b> <span id="textbox-tier-III">...</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        import { asset_loader, render } from "./modules/card-render.js";
        import { card as demo_card } from "./modules/demoCards.js";
        import * as editor from "./modules/editor.js";
        import * as storage from "./modules/storage.js";

        window.addEventListener('DOMContentLoaded',function () {
            var canvas = document.getElementById("card");
            var ctx = canvas.getContext("2d");
            
            document.addEventListener('gfx ready', function(e) {
                render(ctx, canvas, demo_card);
            });
            const gfxLoadedEvent = new Event("gfx ready");
            
            if (localStorage.getItem('workspace') != null) {
                editor.set_branch(storage.loadWorkSpace());
            }
            editor.guiUpdate();

            asset_loader(function() { 
                //document.dispatchEvent(gfxLoadedEvent); 
                document.getElementById("preview-tier-I").click();
            });
        });

        function valueChange() {
            storage.saveWorkSpace(editor.get_branch());
        }

        function drawCard(tier = '') {
            if (tier == '') tier = currentTier;
            let branch = editor.get_branch();
            let card = editor.getCard(branch, tier);
            render(ctx, canvas, card);
        }

        function guiUpdate() {
            editor.guiUpdate();
            valueChange();
            drawCard();
        }

        // ============================================================================
        // ============================================================================
        // TESTING CODE
        document.getElementById("test-new").addEventListener("click", function (e) {
            editor.input_card_id.value = "";
        });

        document.getElementById("test-save").addEventListener("click", function (e) {
            let branch = editor.get_branch();
            console.log(branch);
            storage.save(branch);
        });
        
        document.getElementById("test-load").addEventListener("click", function (e) {
            let val = parseInt(document.getElementById('test-load-id').value);
            console.log(val);
            let branch = storage.getBranches()[val];
            console.log(branch);
            if (branch != null)
            editor.set_branch(storage.getBranch(branch));
            guiUpdate();
        });
        
        document.getElementById("test-clear").addEventListener("click", function (e) {
            localStorage.clear();
        });
        document.getElementById("test-log").addEventListener("click", function (e) {
            console.log(localStorage);
        });
        // ============================================================================
        // ============================================================================

        var currentTier = 'I';
        const canvas = document.getElementById("card");
        const ctx = canvas.getContext("2d");
        ['I','II','III'].forEach(function (tier, i) {
            document.getElementById("preview-tier-"+tier)
                .addEventListener("click", function (e) {
                    currentTier = tier;
                    drawCard(tier);
            });
        });

        
    
        const select_supertype = document.getElementById("supertype");
        const select_stat_type = document.getElementById("stat-type");
        const select_card_color = document.getElementById("card-color");
        const input_tier_toggle = document.getElementsByName("tier-toggle");
        const input_features_toggle = document.getElementsByName("features-toggle");

        const select_stat_profile = function (stat) { return document.getElementById(stat + "-profile"); };
        const input_stats = function (stat) { return [
            document.getElementById(stat + "-tier-I"),
            document.getElementById(stat + "-tier-II"),
            document.getElementById(stat + "-tier-III")
        ]; };

        const select_type = document.getElementById("card-type");
        const select_type_tier_ii = document.getElementById("card-type-tier-II");
        const select_type_tier_iii = document.getElementById("card-type-tier-III");
        const input_textbox = document.getElementById("textbox");
        const input_subtype = document.getElementsByName("subtype");
        const input_tier_ii_item = document.getElementsByName("tier-II-item");
        const input_tier_iii_item = document.getElementsByName("tier-III-item");

        editor.select_supertype.addEventListener("change", function (e) { guiUpdate(); });
        select_card_color.addEventListener("change", function (e) { guiUpdate(); });
        select_type.addEventListener("change", function (e) { guiUpdate(); });

        input_features_toggle.forEach(function (e) {
            e.addEventListener("change", function (ee) { guiUpdate(); });
        });        

        ['attack','defense','movement','initiative'].forEach(function (stat) {
            select_stat_profile(stat).addEventListener("change", function (e) {
                if (select_stat_type.value == "Profile") {
                    e.target.dataset.value = e.target.value;
                }
                guiUpdate(); 
            });
            
            input_stats(stat).forEach(function (e) {
                e.addEventListener("change", function (v) { 
                    guiUpdate(); 
                });
            });

            // Attribute hiding
            document.getElementById(stat + "-toggle").addEventListener("change", function (e) {
                const checked = e.target.checked;
                document.getElementById(stat +"-hide").checked = checked;

                const opts = select_type.children;
                for (var i = 0; i < opts.length; i++) {
                    const opt = opts[i].value.toLowerCase();
                    if (opt == stat) {
                        opts[i].hidden = checked ? false : true;
                    }
                    if (opt == 'defense/skill' && stat == "defense") {
                        opts[i].hidden = checked ? false : true;
                    }
                }
                valueChange(); // guiUpdate here would cause infinite recursion
            });
        });

        select_stat_type.addEventListener("change", function (e) {
            const val = e.target.value;
            const elem_list = document.getElementsByClassName("stat-profile");
            for (var i = 0; i < elem_list.length; i++) {
                const ee = elem_list[i].firstElementChild;
                if (val == "Custom") {
                    ee.value = val;
                    ee.disabled = true;
                } else {
                    ee.disabled = (val == "Inherit");
                }
                if (val == "Profile") {
                    ee.value = ee.dataset.value;
                }
            }
            guiUpdate(); 
        });

        input_tier_toggle.forEach(function (e) {
            e.addEventListener("change", function (v) {
                const check = v.target.checked;
                const tier = v.target.value;
                const elem_list = document.getElementsByClassName("tier-" + tier);
                for (var i = 0; i < elem_list.length; i++) {
                    const ee = elem_list[i];
                    if (ee.tagName == "INPUT" || ee.tagName == "SELECT" || ee.tagName == "BUTTON") {

                        // Deal with subtype-value boxes
                        if (ee.id.slice(0, 18) == "subtype-value-tier") {
                            if (document.getElementById("subtype-none").checked)
                                ee.disabled = true;
                            else
                                ee.disabled = !check;
                            continue;
                        } 
                        ee.disabled = !check;
                    } else if (ee.tagName == "DIV" || ee.tagName == "SPAN") {
                        if (!check) 
                            ee.classList.add("disabled");  
                        else
                            ee.classList.remove("disabled");  
                    } else {
                        ee.style.display = check ? "block" : "none";
                    }
                }
                valueChange(); // guiUpdate here would cause infinite recursion
            });
        });

        input_subtype.forEach(function (e) {
            e.addEventListener("change", function (v) {
                if (v.target.checked) {
                    input_subtype.forEach(function (ee) {
                        if (ee != e) {
                            ee.checked = false;
                        }
                    });
                }
                ['I','II','III'].forEach(function (tier, i) {
                    const elem = document.getElementById("subtype-value-tier-" + tier);
                    if (v.target.value == "none") {
                        elem.disabled = true;
                    } else {
                        if (input_tier_toggle[i].checked)
                            elem.disabled = false;
                    }
                });
                guiUpdate(); 
            });
        });

        editor.input_subtype_value.forEach(function (e, i) {
            e.addEventListener("change", function (ee) {
                currentTier = 'I'.repeat(i+1);
                guiUpdate();
            });
        });

        editor.input_name.forEach(function (e, i) {
            e.addEventListener("change", function (ee) {
                currentTier = 'I'.repeat(i+1);
                guiUpdate();
            });
        });

        input_textbox.addEventListener("input", function (e) {
            const text = e.srcElement.value;
            ['I','II','III'].forEach(function(tier) {
                const elem = document.getElementById("textbox-tier-" + tier);
                elem.innerHTML = editor.textbox_parser(text, tier);
            });
        });
        input_textbox.addEventListener("change", function (e) {
            guiUpdate();
        });

        input_tier_ii_item.forEach(function (e) {
            e.addEventListener("change", function (v) {
                if (v.target.checked) {
                    input_tier_ii_item.forEach(function (ee) {
                        if (ee != e) {
                            ee.checked = false;
                        }
                    });
                }
                currentTier = 'II';
                guiUpdate(); 
            });
        });

        input_tier_iii_item.forEach(function (e) {
            e.addEventListener("change", function (v) {
                if (v.target.checked) {
                    input_tier_iii_item.forEach(function (ee) {
                        if (ee != e) {
                            ee.checked = false;
                        }
                    });
                }
                currentTier = 'III';
                guiUpdate(); 
            });
        });

        // DEMO STUFF
        var event_input = new Event('input');
        input_textbox.dispatchEvent(event_input);
        /*var event_change = new Event('change');
        input_tier_toggle[0].toggleAttribute("checked");
        input_tier_toggle[0].dispatchEvent(event_change);
        editor.guiUpdateStat('All');*/

        function saveCanvasAsPNG() {
            // Get the canvas element and its context
            var canvas = document.getElementById("card");
            var ctx = canvas.getContext("2d");

            // Convert the canvas content to a data URL
            var dataURL = canvas.toDataURL("image/png");

            // Create a link element
            var link = document.createElement("a");
            link.href = dataURL;
            link.download = "card.png"; // Set the file name

            // Simulate a click on the link to trigger the download
            link.click();
        }
    </script>
</body>
</html>